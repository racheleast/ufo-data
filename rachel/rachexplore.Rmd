---
title: "UFO Sightings Exploratory Analysis "
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r echo=FALSE, include=FALSE}

library(mapview)
library(sf)
library(tidyverse)
library(here)
library(ggplot2)
library(ggmap)
library(rworldmap)
library(readxl)
library(plotly)
library(pander)
library(usmap)


here::here()

data <- read_csv(here("nuforc_reports.csv"))

```

### Maps of Sightings


```{r map, echo=FALSE, warning=FALSE, message=FALSE}

longitudes <- na.omit(data$city_longitude) # Get rid of N/A rows 
latitudes <- na.omit(data$city_latitude) # Get rid of N/A rows

newrows <- data.frame(longitudes,latitudes) # Create new data frame with our revised variables

world <- getMap(resolution = "medium") # Get data for map

# Make a map for all UFO sightings

(mapufo <- ggplot() +
    geom_polygon(data = world, aes(x = long, y = lat, group = group), fill = NA, colour = "black") + # Plot Map
    geom_point(data = newrows, aes(x = longitudes, y = latitudes) , colour = "green4", cex = .05 ) + # Plot Data
    theme_classic() + # Remove Grey Background
    ylim(10, 70) +
    xlim(-170,-50) +
    xlab("Longitude") +
    ylab("Latitude") +
    ggtitle("UFO Sightings"))+
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```



```{r, echo=FALSE, warning=FALSE, message=FALSE}


data$sighting_year <- lubridate::year(data$date_time)


newdata <- data.frame(data$sighting_year ,data$city_longitude, data$city_latitude)
newdata2 <- na.omit(newdata) # Get rid of empty rows


earlydata <- subset(newdata2, newdata2$data.sighting_year <= 2005) # UFO sightings before 2005
laterdata <- subset(newdata2, newdata2$data.sighting_year > 2005) # UFO sightings after 2005 


# Make a map for earlydata


(mapufo <- ggplot() +
    geom_polygon(data = world, aes(x = long, y = lat, group = group), fill = NA, colour = "black") + # Plot Map
    geom_point(data = earlydata, aes(x = earlydata$data.city_longitude , y = earlydata$data.city_latitude) , colour = "red", cex = .05 ) + # Plot Data
    theme_classic() + # Remove Grey Background
    ylim(10, 70) +
    xlim(-170,-50) +
    xlab("Longitude") +
    ylab("Latitude") +
    ggtitle("UFO Sightings Before 2005"))+
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Make a map for laterdata


(mapufo <- ggplot() +
    geom_polygon(data = world, aes(x = long, y = lat, group = group), fill = NA, colour = "black") + # Plot Map
    geom_point(data = laterdata, aes(x = laterdata$data.city_longitude , y = laterdata$data.city_latitude) , colour = "blue", cex = .05 ) + # Plot Data
    theme_classic() + # Remove Grey Background
    ylim(10, 70) +
    xlim(-170,-50) +
    xlab("Longitude") +
    ylab("Latitude") +
    ggtitle("UFO Sightings After 2005"))+
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

##### We can see from these maps that a lot of the sightings tend to group together in certain areas. What is the reason for this? Our first perdiction is that there is a correlation between UFO activity and the U.S. nuclear power plants. We will be exploring this theory in the next section.


### Nuclear Power Plant Analysis



```{r, echo=FALSE, warning=FALSE, message=FALSE}


NuclearData <- read_excel(here("NuclearData.xlsx"))

NuclearData2 <- data.frame(NuclearData$`Reactor Name`,NuclearData$Longitude, NuclearData$Latitude)

NuclearData3 <- na.omit(NuclearData2)


# Going to plot the nuclear power plants and the ufo sightings on the same map


MainStates <- map_data("state")

(mapufo <- ggplot() +
    geom_polygon(data = MainStates, aes(x = long, y = lat, group = group), fill = NA, color = "black") + # Plot Map
    geom_point(data = earlydata, aes(x = earlydata$data.city_longitude , y = earlydata$data.city_latitude) , color = "red", cex = .05 ) + # Plot Data
    geom_point(data = NuclearData3, aes(x = NuclearData3$NuclearData.Longitude , y = NuclearData3$NuclearData.Latitude) , color = "blue", cex = 1.5 ) +
    theme_classic() + # Remove Grey Background
    ylim(25, 50) +
    xlim(-125,-65) +
    xlab("Longitude") +
    ylab("Latitude") +
    ggtitle("UFO Sightings Before 2005 With U.S. Nuclear Power Plants"))+
    theme(plot.title = element_text(hjust = 0.5 , face = "bold"))


```

##### From the map alone we can start to see that there is more sightings near power plants. 

##### In this next section I am going to compare the number of power plants per state vs the number of sightings per state. I am going to be working with the early data (before 2005). 

```{r states, echo=FALSE, warning=FALSE, message=FALSE}


# Modifying Our Data


NucPerState <- read_excel(here("NucPerState.xlsx")) # Data set w/states and their count of power plants

statedata <- data.frame(data$sighting_year , data$state) # Creating a data set with just the year/state
statedata2 <- na.omit(statedata) # Get rid of empty rows
earlydata2 <- subset(statedata2, statedata2$data.sighting_year <= 2005) # UFO sightings before 2005

earlydata22 <- earlydata2 %>% group_by(data.state) %>% summarise(count = n()) # This counts the number of sightings per state



# This table will show the number of sightings and number of power plants per state
# I am not going to display this table as it is very large and it doesn't provide information that is easy to interpet/visualize 


perstate <- cbind(earlydata22, NucPerState$Count)



# This next table will take the average number of sighting and compare it to number of power plants


Count0 <- perstate[NucPerState$Count == 0, ]
mean0 <- mean(Count0$count)

Count1 <- perstate[NucPerState$Count == 1, ]
mean1 <- mean(Count1$count)

Count2 <- perstate[NucPerState$Count == 2, ]
mean2 <- mean(Count2$count)

Count3 <- perstate[NucPerState$Count == 3, ]
mean3 <- mean(Count3$count)

Count4 <- perstate[NucPerState$Count == 4, ]
mean4 <- mean(Count4$count)

Count5 <- perstate[NucPerState$Count == 5, ]
mean5 <- mean(Count5$count)

Count7 <- perstate[NucPerState$Count == 7, ]
mean7 <- mean(Count7$count)

Count9 <- perstate[NucPerState$Count == 9, ]
mean9 <- mean(Count9$count)

Count14 <- perstate[NucPerState$Count == 14, ]
mean14 <- mean(Count14$count)

averages <- rbind(mean0, mean1, mean2, mean3, mean4, mean5, mean7, mean9, mean14)
numbers <- c(0, 1, 2, 3, 4, 5, 7, 9, 14)
chart1 <- cbind(numbers, averages)
colnames(chart1) = c("Number of Power Plants in the State", "Average Number of Sightings")
rownames(chart1) = c()

pander(chart1)
plot(numbers, averages, xlab = "Number of Power Plants in the State", ylab = "Average Number of Sightings", col = "red", main = "UFO Sightings Before 2005 VS Nuclear Power Plants", pch = 19)
#cor(numbers, averages)
```

##### Based on our visuals it seems like we have a positive correlation between the number of power plants and the number of sightings. California and South Carolina are the 2 states that have 7 power plants, but California has 650 sightings where as South Carolina has only 90. California is defintely the outlier of this data as the next highest number of sightings is 301 (Texas). Based on our "README" I think California has some other factors (San Andreas Fault, Los Angeles, Earthquakes) that contribute to more sightings. We will have to consider this as we continue our analysis. 

#### Nuclear Range 


##### One degree of latitude is approxiamtely 69 miles, and one degree of longitude is about 54.6 miles. We are going to be looking at the number of sightings that occur within one degree from our power plants. This accounts for about 15,069.6 square miles.   

```{r }

# Creating a new table with ranges for our longitudes and latittudes


NuclearData4 <- data.frame(NuclearData3$NuclearData..Reactor.Name., NuclearData3$NuclearData.Longitude - 1, NuclearData3$NuclearData.Longitude + 1, NuclearData3$NuclearData.Latitude - 1, NuclearData3$NuclearData.Latitude + 1)
colnames(NuclearData4) = c("Reactor Name", "Lower Longitude", "Upper Longitude", "Lower Latitude", "Upper Latitude")


# Iterating through both data sets to count the number of sightings in our ranges 


x = c()

for(i in 1:nrow(NuclearData4)){
    y <- 0
   for (j in 1:nrow(earlydata)){
       if(NuclearData4[i,2] <= earlydata[j,2] && earlydata[j,2] <= NuclearData4[i,3] && NuclearData4[i,4] <= earlydata[j,3] && earlydata[j,3] <= NuclearData4[i,5]) {y <- y + 1}
       else {}
       } 
    if(y >= 0){ x <- append(x, y)}
} 
  

```

Notes : The code works, but it is fairly slow. In python we would use vectorized for loops to increase speed but I am unsure of how to do this in R.


```{r echo=FALSE, warning=FALSE, message=FALSE}

counting <- data.frame(x) # Making vector into data frame so its easier to put into table

newtable <- cbind(NuclearData4$`Reactor Name`, counting) # Creating new table
colnames(newtable) = c("Reactor Name", "Count of Sightings Near")


pander(newtable)
p = rbind( sum(counting), 4737)
colnames(p) = c("Number of Sightings")
rownames(p)= c("Near Power Plants", "Total")

pander(p)
```

##### From this data we can see that about 84% of our sightings occur within about 55-70 miles from our power plants. 

##### I have decided to zoom in on the map and check our count for one of the power plants. I am using the power plant "Diablo Canyon 1" which on the table has 14 counts, but as you will see on the map there are only 11 sightings in our range. I am unsure as to why the map isn't corresponding to the table. 


```{r echo=FALSE, warning=FALSE, message=FALSE}
(mapufo <- ggplot() +
    geom_point(data = earlydata, aes(x = earlydata$data.city_longitude , y = earlydata$data.city_latitude) , color = "red", cex = 1 ) + # Plot Data
    geom_point(data = NuclearData3, aes(x = NuclearData3$NuclearData.Longitude , y = NuclearData3$NuclearData.Latitude) , color = "blue", cex = 4 ) +
    theme_classic() + # Remove Grey Background
    ylim(34.1, 36.2) +
    xlim(-121.9, -119.7) +
    xlab("Longitude") +
    ylab("Latitude") +
    ggtitle("UFO Sightings at Diablo Canyon Power Plant")) +
    theme(plot.title = element_text(hjust = 0.5 , face = "bold"))
```